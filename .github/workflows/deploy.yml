name: Deploy_to_Internal_Test 
run-name: Deploy to Internal Test ðŸ“±
on: 
    workflow_dispatch: 
jobs:
    BuildCredentiatedApp:
        runs-on: ubuntu-latest
        steps:
            - name: Checkout code
              uses: actions/checkout@v4
              with:
                path: 'source'
            - name: Checkout configuration Repository
              uses: actions/checkout@v4
              with:
                repository: Dragon-Memory-Team/DragonMemoy-App-Configs
                token: ${{ secrets.PAT }}
                path: settings
            - name: Remove placeholder settings
              run: rm ./source/eas.json ./source/credentials.json
            - name: Copy the correct settings
              run: cp -r ./settings/android ./source && cp ./settings/credentials.json ./source && cp ./settings/eas.json ./source
            - name: Zip source code
              run: zip -r DragonMemoryCredentiaded.zip ./source
            - name: 'Upload Source Code with real credentials'
              uses: actions/upload-artifact@v4
              with:
                name: DragonMemoryCredentiated
                path: ./DragonMemoryCredentiaded.zip
                retention-days: 1
    EasBuild:
        needs: [BuildCredentiatedApp]
        runs-on: ubuntu-latest
        env:
          EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}
        steps:
            - name: Download Credentiaded Application Zip
              uses: actions/download-artifact@v4
              with:
                name: DragonMemoryCredentiated
            - name: Unzip Artifacts
              run: unzip ./DragonMemoryCredentiaded.zip
            - name: Setup Node Environment
              uses: actions/setup-node@v4
              with:
                node-version: '20.13.1'
            - name: Install Node Dependencies
              working-directory: source
              run: npm install
            - name: Install EAS Cli Tool
              run: npm install --global eas-cli
            - name: Changing the version of the app.
              working-directory: source
              run: |
                version=$(jq .expo.version ./app.json | sed 's/^"\(.*\)"$/\1/')
                IFS='.' read -r MAJOR MINOR PATCH <<< "$version"
                PATCH=$((PATCH + 1))
                new_version="$MAJOR.$MINOR.$PATCH"
                jq --arg new_version "$new_version" '.expo.version = $new_version' app.json > temp.json && mv temp.json app.json
                echo "Updated version to $new_version"
            - name: EAS Build
              working-directory: source
              run: |
                echo "Building Android Application through EAS"
                EAS_DOWNLOAD_URL=$(eas build -p android | awk '/ðŸ¤– Android app:/ {getline; print $1}')
                echo "Url to download app $EAS_DOWNLOAD_URL"
                FILENAME=$(basename $EAS_DOWNLOAD_URL)
                wget "$EAS_DOWNLOAD_URL"
                echo "FILENAME=$FILENAME" >> $GITHUB_OUTPUT
                zip DragonMemoryApp.zip ./$FILENAME
            - name: 'Upload AAB'
              uses: actions/upload-artifact@v4
              with:
                name: DragonMemory
                path: ./source/DragonMemoryApp.zip
                retention-days: 1
    DeployToInternalTest:
        needs: [EasBuild]
        runs-on: ubuntu-latest
        steps:
          - name: Download Application Binary Artifact
            uses: actions/download-artifact@v4
            with:
              name: DragonMemory
          - name: Checkout configuration Repository
            uses: actions/checkout@v4
            with:
              repository: Dragon-Memory-Team/DragonMemoy-App-Configs
              token: ${{ secrets.PAT }}
              path: settings
          - name: Unzip AAB
            run: unzip ./DragonMemoryApp.zip
          - name: Upload to Internal Test Track
            uses: r0adkll/upload-google-play@v1
            with:
              serviceAccountJson: ${{ secrets.SERVICE_ACCOUNT_PATH }}
              packageName: "br.com.dragonmemory"
              releaseFiles: ./*.aab
              track: internal